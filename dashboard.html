<script>
    // =============================================
    // REGI√ìN: CONFIGURACI√ìN GLOBAL
    // =============================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbwrFOz0gKxzixORDHZZFi36ryjRSJKRRKqqZA26de3mzr3AHZwQv4IWdr3Z2iOyqLPZ0A/exec';
    
    // =============================================
    // VARIABLES GLOBALES
    // =============================================
    let currentUser = null;
    let currentRole = 'super';
    let currentCompany = null;
    let notifications = [];
    
    // Base de datos local (cache)
    const database = {
        empresas: [],
        usuarios: [],
        empleados: [],
        productos: [],
        clientes: [],
        ventas: [],
        facturas: []
    };
    
    // =============================================
    // M√ìDULO: FUNCIONES DE LOADING
    // =============================================
    
    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'flex';
    }
    
    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
    
    // =============================================
    // M√ìDULO: FUNCIONES DE API
    // =============================================
    
    async function fetchFromAPI(action, params = {}) {
        try {
            console.log(`üîç Conectando a API: ${action}`, params);
            
            let url = `${API_URL}?action=${encodeURIComponent(action)}`;
            
            Object.keys(params).forEach(key => {
                if (params[key] !== undefined && params[key] !== null && params[key] !== '') {
                    url += `&${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`;
                }
            });
            
            url += `&_t=${Date.now()}`;
            
            console.log(`üì§ URL completa: ${url}`);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                cache: 'no-cache',
                mode: 'cors',
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            console.log(`üì• Respuesta recibida, status: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log(`‚úÖ Resultado API ${action}:`, result);
            
            return result;
            
        } catch (error) {
            console.error(`‚ùå Error fetchFromAPI (${action}):`, error);
            showNotification('error', 'Error de conexi√≥n', 'No se pudo conectar al servidor. Verifica tu conexi√≥n a internet.');
            throw error;
        }
    }

    async function postToAPI(action, data = {}) {
        try {
            showLoading();
            
            console.log(`üì§ Enviando POST a API: ${action}`, data);
            
            const requestData = {
                action: action,
                ...data,
                timestamp: Date.now()
            };
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestData),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            console.log(`üì• Respuesta status: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log(`‚úÖ Respuesta API ${action}:`, result);
            
            hideLoading();
            
            if (result.success) {
                return result;
            } else {
                throw new Error(result.error || 'Error en la API');
            }
            
        } catch (error) {
            console.error('‚ùå Error en API POST:', error);
            hideLoading();
            
            let errorMessage = error.message;
            if (error.name === 'AbortError') {
                errorMessage = 'Timeout: El servidor tard√≥ demasiado en responder';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Error de conexi√≥n. Verifica tu internet.';
            }
            
            showNotification('error', 'Error de API', errorMessage);
            throw error;
        }
    }
    
    // =============================================
    // M√ìDULO: CARGA DE DATOS DESDE GOOGLE SHEETS
    // =============================================
    
    async function loadEmpresasFromAPI() {
        showLoading();
        try {
            const result = await fetchFromAPI('getEmpresas');
            
            if (result && result.success && result.empresas) {
                database.empresas = result.empresas;
                console.log(`‚úÖ Empresas cargadas: ${result.empresas.length}`);
                return true;
            } else {
                console.warn('‚ö†Ô∏è No se pudieron cargar empresas:', result?.error);
                return false;
            }
        } catch (error) {
            console.error('Error cargando empresas:', error);
            return false;
        } finally {
            hideLoading();
        }
    }
    
    async function loadUsuariosFromAPI(empresaId = null) {
        showLoading();
        try {
            const params = empresaId ? { empresa_id: empresaId } : {};
            const result = await fetchFromAPI('getUsuarios', params);
            if (result && result.success && result.usuarios) {
                database.usuarios = result.usuarios;
                console.log(`‚úÖ Usuarios cargados: ${result.usuarios.length}`);
                return true;
            }
            console.warn('‚ö†Ô∏è No se pudieron cargar usuarios');
            return false;
        } catch (error) {
            console.error('Error cargando usuarios:', error);
            return false;
        } finally {
            hideLoading();
        }
    }
    
    async function loadEmpleadosFromAPI(empresaId = null) {
        showLoading();
        try {
            const params = empresaId ? { empresa_id: empresaId } : {};
            const result = await fetchFromAPI('getEmpleados', params);
            if (result && result.success && result.empleados) {
                database.empleados = result.empleados;
                console.log(`‚úÖ Empleados cargados: ${result.empleados.length}`);
                return true;
            }
            console.warn('‚ö†Ô∏è No se pudieron cargar empleados');
            return false;
        } catch (error) {
            console.error('Error cargando empleados:', error);
            return false;
        } finally {
            hideLoading();
        }
    }
    
    async function loadProductosFromAPI(empresaId = null) {
        showLoading();
        try {
            const params = empresaId ? { empresa_id: empresaId } : {};
            const result = await fetchFromAPI('getProductos', params);
            if (result && result.success && result.productos) {
                database.productos = result.productos;
                console.log(`‚úÖ Productos cargados: ${result.productos.length}`);
                return true;
            }
            console.warn('‚ö†Ô∏è No se pudieron cargar productos');
            return false;
        } catch (error) {
            console.error('Error cargando productos:', error);
            return false;
        } finally {
            hideLoading();
        }
    }
    
    async function loadClientesFromAPI(empresaId = null) {
        showLoading();
        try {
            const params = empresaId ? { empresa_id: empresaId } : {};
            const result = await fetchFromAPI('getClientes', params);
            if (result && result.success && result.clientes) {
                database.clientes = result.clientes;
                console.log(`‚úÖ Clientes cargados: ${result.clientes.length}`);
                return true;
            }
            console.warn('‚ö†Ô∏è No se pudieron cargar clientes');
            return false;
        } catch (error) {
            console.error('Error cargando clientes:', error);
            return false;
        } finally {
            hideLoading();
        }
    }
    
    async function loadAllData() {
        showLoading();
        try {
            await Promise.all([
                loadEmpresasFromAPI(),
                loadUsuariosFromAPI(),
                loadEmpleadosFromAPI(),
                loadProductosFromAPI(),
                loadClientesFromAPI()
            ]);
            console.log('‚úÖ Todos los datos cargados exitosamente desde Google Sheets');
            showNotification('success', 'Datos actualizados', 'Informaci√≥n sincronizada correctamente con Google Sheets');
            return true;
        } catch (error) {
            console.error('Error cargando datos:', error);
            showNotification('error', 'Error de carga', 'No se pudieron cargar todos los datos');
            return false;
        } finally {
            hideLoading();
        }
    }
    
    async function refreshData() {
        showNotification('info', 'Actualizando', 'Sincronizando con Google Sheets...');
        await loadAllData();
        
        // Recargar la vista actual
        if (currentUser.role === 'super') {
            loadSuperDashboard();
        } else if (currentUser.role === 'jefe') {
            loadJefeDashboard();
        }
    }
    
    // =============================================
    // M√ìDULO: CONFIGURACI√ìN DE INTERFAZ POR ROL
    // =============================================
    
    function configureInterface() {
        console.log('üé® Configurando interfaz para rol:', currentUser.role);
        
        const roleConfigs = {
            'super': {
                badgeClass: 'super-admin',
                badgeText: 'SUPER ADMIN',
                userName: currentUser.nombre || 'Administrador Corporativo',
                userRole: 'Control Total Sistema',
                viewId: 'viewSuper',
                navMenu: `
                <div class="nav-section">
                    <div class="nav-title">CORPORATIVO</div>
                    <ul class="nav-links">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="loadSuperDashboard()">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Panel de Control</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="loadEmpresasManagement()">
                        <i class="fas fa-building"></i>
                        <span>Gesti√≥n de Empresas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="loadGestionPersonal()">
                        <i class="fas fa-users-cog"></i>
                        <span>Gesti√≥n de Personal</span>
                        </a>
                    </li>
                    </ul>
                </div>
                `,
                pageTitle: 'Panel de Control Corporativo'
            },
            'jefe': {
                badgeClass: 'jefe',
                badgeText: 'JEFE EMPRESA',
                userName: currentUser.nombre || 'Jefe de Empresa',
                userRole: 'Gesti√≥n Empresarial',
                viewId: 'viewJefe',
                navMenu: `
                <div class="nav-section">
                    <div class="nav-title">EMPRESA</div>
                    <ul class="nav-links">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="loadJefeDashboard()">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard Empresa</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="loadUsuariosEmpresa()">
                        <i class="fas fa-users"></i>
                        <span>Gesti√≥n de Usuarios</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="loadProductosEmpresa()">
                        <i class="fas fa-boxes"></i>
                        <span>Productos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="loadClientesEmpresa()">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                        </a>
                    </li>
                    </ul>
                </div>
                `,
                pageTitle: 'Dashboard Empresa'
            }
        };
        
        const config = roleConfigs[currentUser.role] || roleConfigs.super;
        
        document.getElementById('userBadge').className = `user-badge ${config.badgeClass}`;
        document.getElementById('userBadge').textContent = config.badgeText;
        document.getElementById('userName').textContent = config.userName;
        document.getElementById('userRole').textContent = config.userRole;
        document.getElementById('sidebarCompanyName').textContent = currentUser.empresa || 'NEXIAL SUITE';
        document.getElementById('navMenu').innerHTML = config.navMenu;
        document.getElementById('pageTitle').textContent = config.pageTitle;
        
        document.querySelectorAll('.role-view').forEach(view => {
            view.classList.remove('active');
            view.innerHTML = '';
        });
        
        const activeView = document.getElementById(config.viewId);
        activeView.classList.add('active');
        
        if (currentUser.role === 'super') {
            loadSuperDashboard();
        } else if (currentUser.role === 'jefe') {
            loadJefeDashboard();
        }
        
        console.log('‚úÖ Interfaz configurada exitosamente');
    }
    
    // =============================================
    // M√ìDULO: DASHBOARD SUPER USUARIO
    // =============================================
    
    function loadSuperDashboard() {
        const empresasCount = database.empresas.length;
        const usuariosCount = database.usuarios.length;
        const empleadosCount = database.empleados.length;
        const productosCount = database.productos.length;
        
        document.getElementById('viewSuper').innerHTML = `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn btn-secondary" onclick="refreshData()" title="Actualizar datos">
                    <i class="fas fa-sync-alt"></i> Actualizar Datos
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Empresas Activas</div>
                        <div class="stat-icon"><i class="fas fa-building"></i></div>
                    </div>
                    <div class="stat-value">${empresasCount}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> Total registradas
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Usuarios Totales</div>
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="stat-value">${usuariosCount}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> En sistema
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Empleados</div>
                        <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                    </div>
                    <div class="stat-value">${empleadosCount}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-user-plus"></i> Registrados
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Productos</div>
                        <div class="stat-icon"><i class="fas fa-boxes"></i></div>
                    </div>
                    <div class="stat-value">${productosCount}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-chart-line"></i> En inventario
                    </div>
                </div>
            </div>
            
            <div class="table-card" style="margin-top: 2rem;">
                <div class="table-header">
                    <h3 class="table-title">Resumen de Empresas</h3>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="loadEmpresasManagement()">
                            <i class="fas fa-list"></i> Ver Todas
                        </button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Empresa</th>
                                <th>Industria</th>
                                <th>Contacto</th>
                                <th>Usuarios</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${database.empresas.slice(0, 5).map(empresa => {
                                const usuariosEmpresa = database.usuarios.filter(u => u.EmpresaID === empresa.ID);
                                return `
                                    <tr>
                                        <td>
                                            <strong>${empresa.Nombre}</strong>
                                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                                                ${empresa.RUC || ''}
                                            </div>
                                        </td>
                                        <td>${empresa.Industria || ''}</td>
                                        <td>${empresa.Contacto || ''}</td>
                                        <td>${usuariosEmpresa.length}</td>
                                        <td>
                                            <span class="status-badge ${empresa.Estado === 'Activa' ? 'status-active' : 'status-inactive'}">
                                                ${empresa.Estado || 'Inactiva'}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-btn view" onclick="viewEmpresaCompleta('${empresa.ID}')" title="Ver Detalles">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="action-btn edit" onclick="editEmpresaCompleta('${empresa.ID}')" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                            ${database.empresas.length === 0 ? `
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-building" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No hay empresas registradas
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div style="margin-top: 2rem; text-align: center;">
                <p style="color: rgba(255,255,255,0.7);">
                    <i class="fas fa-info-circle"></i> Sistema conectado a Google Sheets. Datos en tiempo real.
                </p>
            </div>
        `;
        
        document.getElementById('pageTitle').textContent = 'Panel de Control Corporativo';
    }
    
    // =============================================
    // M√ìDULO: DASHBOARD JEFE EMPRESA
    // =============================================
    
    function loadJefeDashboard() {
        const empresaId = currentUser.empresa_id;
        const empresa = database.empresas.find(e => e.ID === empresaId) || {};
        const usuariosEmpresa = database.usuarios.filter(u => u.EmpresaID === empresaId);
        const empleadosEmpresa = database.empleados.filter(e => e.EmpresaID === empresaId);
        const productosEmpresa = database.productos.filter(p => p.EmpresaID === empresaId);
        const clientesEmpresa = database.clientes.filter(c => c.EmpresaID === empresaId);
        
        document.getElementById('viewJefe').innerHTML = `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn btn-secondary" onclick="refreshData()" title="Actualizar datos">
                    <i class="fas fa-sync-alt"></i> Actualizar Datos
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Usuarios Activos</div>
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="stat-value">${usuariosEmpresa.length}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-user-check"></i> En tu empresa
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Empleados</div>
                        <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                    </div>
                    <div class="stat-value">${empleadosEmpresa.length}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-user-plus"></i> Registrados
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Productos</div>
                        <div class="stat-icon"><i class="fas fa-boxes"></i></div>
                    </div>
                    <div class="stat-value">${productosEmpresa.length}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-cubes"></i> En stock
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Clientes</div>
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="stat-value">${clientesEmpresa.length}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-handshake"></i> Activos
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">Usuarios de la Empresa</h3>
                        <button class="btn btn-primary" onclick="loadUsuariosEmpresa()" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-users"></i> Gestionar
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usuariosEmpresa.slice(0, 5).map(usuario => `
                                    <tr>
                                        <td>${usuario.Nombre}</td>
                                        <td>
                                            <span style="display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${getRoleColor(usuario.Role)}; font-size: 0.8rem;">
                                                ${getRoleName(usuario.Role)}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="status-badge ${usuario.Activo === 'S√≠' ? 'status-active' : 'status-inactive'}">
                                                ${usuario.Activo === 'S√≠' ? 'Activo' : 'Inactivo'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${usuariosEmpresa.length === 0 ? `
                                    <tr>
                                        <td colspan="3" style="text-align: center; padding: 1rem; color: rgba(255,255,255,0.5);">
                                            No hay usuarios registrados
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">Informaci√≥n de la Empresa</h3>
                        <button class="btn btn-primary" onclick="editarInformacionEmpresa()" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>
                    <div style="padding: 1rem;">
                        <p><strong>RUC/NIT:</strong> ${empresa.RUC || 'No registrado'}</p>
                        <p><strong>Contacto:</strong> ${empresa.Contacto || 'No registrado'}</p>
                        <p><strong>Email:</strong> ${empresa.Email || 'No registrado'}</p>
                        <p><strong>Tel√©fono:</strong> ${empresa.Tel√©fono || 'No registrado'}</p>
                        <p><strong>Industria:</strong> ${empresa.Industria || 'No especificada'}</p>
                        <p><strong>Direcci√≥n:</strong> ${empresa.Direcci√≥n || 'No registrada'}</p>
                        <p><strong>Estado:</strong> 
                            <span class="status-badge ${empresa.Estado === 'Activa' ? 'status-active' : 'status-inactive'}">
                                ${empresa.Estado || 'Inactiva'}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 1.5rem; text-align: center;">
                <p style="color: rgba(255,255,255,0.7);">
                    <i class="fas fa-database"></i> Conectado a Google Sheets. Datos en tiempo real.
                </p>
            </div>
        `;
        
        document.getElementById('pageTitle').textContent = `Dashboard - ${empresa.Nombre || 'Mi Empresa'}`;
    }
    
    // =============================================
    // M√ìDULO: GESTI√ìN DE USUARIOS POR EMPRESA
    // =============================================
    
    function loadUsuariosEmpresa() {
        const empresaId = currentUser.empresa_id;
        const empresa = database.empresas.find(e => e.ID === empresaId);
        
        showModal(`Gesti√≥n de Usuarios - ${empresa.Nombre}`, `
            <div style="max-width: 800px;">
                <div style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="showNuevoUsuarioParaEmpresa('${empresaId}')">
                        <i class="fas fa-user-plus"></i> Agregar Usuario
                    </button>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${database.usuarios.filter(u => u.EmpresaID === empresaId).map(usuario => `
                                <tr>
                                    <td>${usuario.Nombre}</td>
                                    <td>${usuario.Email}</td>
                                    <td>
                                        <span style="display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${getRoleColor(usuario.Role)}; font-size: 0.8rem;">
                                            ${getRoleName(usuario.Role)}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge ${usuario.Activo === 'S√≠' ? 'status-active' : 'status-inactive'}">
                                            ${usuario.Activo === 'S√≠' ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn edit" onclick="editUsuarioCompleto('${usuario.ID}')" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="action-btn delete" onclick="confirmarEliminarUsuario('${usuario.ID}', '${usuario.Nombre}')" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                            ${database.usuarios.filter(u => u.EmpresaID === empresaId).length === 0 ? `
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No hay usuarios en esta empresa
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `);
    }
    
    // =============================================
    // M√ìDULO: GESTI√ìN DE PRODUCTOS POR EMPRESA
    // =============================================
    
    function loadProductosEmpresa() {
        const empresaId = currentUser.empresa_id;
        const empresa = database.empresas.find(e => e.ID === empresaId);
        const productosEmpresa = database.productos.filter(p => p.EmpresaID === empresaId);
        
        showModal(`Productos - ${empresa.Nombre}`, `
            <div style="max-width: 900px;">
                <div style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="showNuevoProductoModal('${empresaId}')">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Categor√≠a</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productosEmpresa.map(producto => `
                                <tr>
                                    <td>${producto.Codigo || ''}</td>
                                    <td>${producto.Nombre || ''}</td>
                                    <td>${producto.Categoria || ''}</td>
                                    <td>$${parseFloat(producto.Precio || 0).toFixed(2)}</td>
                                    <td>${producto.Stock || 0}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn edit" onclick="editarProducto('${producto.ID}')" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="action-btn delete" onclick="eliminarProducto('${producto.ID}', '${producto.Nombre}')" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                            ${productosEmpresa.length === 0 ? `
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-boxes" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No hay productos registrados
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `);
    }
    
    // =============================================
    // M√ìDULO: GESTI√ìN DE CLIENTES POR EMPRESA
    // =============================================
    
    function loadClientesEmpresa() {
        const empresaId = currentUser.empresa_id;
        const empresa = database.empresas.find(e => e.ID === empresaId);
        const clientesEmpresa = database.clientes.filter(c => c.EmpresaID === empresaId);
        
        showModal(`Clientes - ${empresa.Nombre}`, `
            <div style="max-width: 900px;">
                <div style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="showNuevoClienteModal('${empresaId}')">
                        <i class="fas fa-plus"></i> Agregar Cliente
                    </button>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>RUC</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clientesEmpresa.map(cliente => `
                                <tr>
                                    <td>${cliente.Nombre || ''}</td>
                                    <td>${cliente.RUC || ''}</td>
                                    <td>${cliente.Email || ''}</td>
                                    <td>${cliente.Telefono || ''}</td>
                                    <td>
                                        <span class="status-badge ${cliente.Estado === 'Activo' ? 'status-active' : 'status-inactive'}">
                                            ${cliente.Estado || 'Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn edit" onclick="editarCliente('${cliente.ID}')" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="action-btn delete" onclick="eliminarCliente('${cliente.ID}', '${cliente.Nombre}')" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                            ${clientesEmpresa.length === 0 ? `
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No hay clientes registrados
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `);
    }
    
    // =============================================
    // M√ìDULO: EDICI√ìN DE INFORMACI√ìN DE EMPRESA
    // =============================================
    
    function editarInformacionEmpresa() {
        const empresaId = currentUser.empresa_id;
        const empresa = database.empresas.find(e => e.ID === empresaId);
        
        showModal(`Editar Empresa: ${empresa.Nombre}`, `
            <div style="max-width: 700px;">
                <input type="hidden" id="editEmpresaId" value="${empresa.ID || ''}">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label style="color: var(--secondary);">Raz√≥n Social *</label>
                        <input type="text" id="editEmpresaNombre" value="${empresa.Nombre || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">RUC/NIT *</label>
                        <input type="text" id="editEmpresaRUC" value="${empresa.RUC || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Industria *</label>
                        <select id="editEmpresaIndustria" required>
                            <option value="">Seleccionar industria</option>
                            <option value="Tecnolog√≠a" ${empresa.Industria === 'Tecnolog√≠a' ? 'selected' : ''}>Tecnolog√≠a</option>
                            <option value="Comercio" ${empresa.Industria === 'Comercio' ? 'selected' : ''}>Comercio</option>
                            <option value="Manufactura" ${empresa.Industria === 'Manufactura' ? 'selected' : ''}>Manufactura</option>
                            <option value="Servicios" ${empresa.Industria === 'Servicios' ? 'selected' : ''}>Servicios</option>
                            <option value="Alimentos" ${empresa.Industria === 'Alimentos' ? 'selected' : ''}>Alimentos</option>
                            <option value="Construcci√≥n" ${empresa.Industria === 'Construcci√≥n' ? 'selected' : ''}>Construcci√≥n</option>
                            <option value="Otros" ${empresa.Industria === 'Otros' ? 'selected' : ''}>Otros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Contacto *</label>
                        <input type="text" id="editEmpresaContacto" value="${empresa.Contacto || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Email *</label>
                        <input type="email" id="editEmpresaEmail" value="${empresa.Email || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Tel√©fono *</label>
                        <input type="text" id="editEmpresaTelefono" value="${empresa.Tel√©fono || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Direcci√≥n</label>
                        <input type="text" id="editEmpresaDireccion" value="${empresa.Direcci√≥n || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Ciudad</label>
                        <input type="text" id="editEmpresaCiudad" value="${empresa.Ciudad || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Estado *</label>
                        <select id="editEmpresaEstado" required>
                            <option value="Activa" ${empresa.Estado === 'Activa' ? 'selected' : ''}>Activa</option>
                            <option value="Inactiva" ${empresa.Estado === 'Inactiva' ? 'selected' : ''}>Inactiva</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="guardarEdicionEmpresaCompleta('${empresaId}')" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        `);
    }
    
    // =============================================
    // M√ìDULO: GESTI√ìN DE EMPRESAS (SUPER ADMIN)
    // =============================================
    
    function loadEmpresasManagement() {
        document.getElementById('pageTitle').textContent = 'Gesti√≥n de Empresas - Super Admin';
        
        document.getElementById('viewSuper').innerHTML = `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn btn-secondary" onclick="refreshData()" title="Actualizar datos">
                    <i class="fas fa-sync-alt"></i> Actualizar Datos
                </button>
            </div>
            
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title">Empresas del Sistema</h3>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="showNuevaEmpresaModal()">
                            <i class="fas fa-plus"></i> Nueva Empresa
                        </button>
                        <button class="btn btn-secondary" onclick="loadSuperDashboard()">
                            <i class="fas fa-arrow-left"></i> Volver al Dashboard
                        </button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="display: none;">ID</th>
                                <th>Empresa</th>
                                <th>Industria</th>
                                <th>Contacto</th>
                                <th>Estado</th>
                                <th>Usuarios</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${database.empresas.map(empresa => {
                                const usuariosEmpresa = database.usuarios.filter(u => u.EmpresaID === empresa.ID);
                                return `
                                    <tr>
                                        <td style="display: none;" data-id="${empresa.ID || 'N/A'}">${empresa.ID || 'N/A'}</td>
                                        <td>
                                            <strong>${empresa.Nombre}</strong>
                                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                                                ${empresa.RUC || ''}
                                            </div>
                                        </td>
                                        <td>${empresa.Industria || ''}</td>
                                        <td>${empresa.Contacto || ''}</td>
                                        <td>
                                            <span class="status-badge ${empresa.Estado === 'Activa' ? 'status-active' : 'status-inactive'}">
                                                ${empresa.Estado || 'Inactiva'}
                                            </span>
                                        </td>
                                        <td>${usuariosEmpresa.length}</td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-btn view" onclick="viewEmpresaCompleta('${empresa.ID}')" title="Ver Detalles">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="action-btn edit" onclick="editEmpresaCompleta('${empresa.ID}')" title="Editar Todo">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="action-btn delete" onclick="confirmarEliminarEmpresa('${empresa.ID}', '${empresa.Nombre}')" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button class="action-btn view" onclick="manageUsuariosEmpresa('${empresa.ID}')" title="Usuarios">
                                                    <i class="fas fa-users"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                            ${database.empresas.length === 0 ? `
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-building" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No hay empresas registradas
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    // =============================================
    // M√ìDULO: GESTI√ìN DE PERSONAL (SUPER ADMIN)
    // =============================================
    
    function loadGestionPersonal() {
        document.getElementById('pageTitle').textContent = 'Gesti√≥n de Personal - Super Admin';
        
        const usuariosParaMostrar = database.usuarios.filter(u => 
            u.ID && u.ID !== '' && 
            u.Role !== 'super'
        );
        
        document.getElementById('viewSuper').innerHTML = `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn btn-secondary" onclick="refreshData()" title="Actualizar datos">
                    <i class="fas fa-sync-alt"></i> Actualizar Datos
                </button>
            </div>
            
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title">Usuarios del Sistema</h3>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="showNuevoUsuarioModalAvanzado()">
                            <i class="fas fa-user-plus"></i> Nuevo Usuario
                        </button>
                        <button class="btn btn-secondary" onclick="loadSuperDashboard()">
                            <i class="fas fa-arrow-left"></i> Volver al Dashboard
                        </button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Empresa</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${usuariosParaMostrar.map(usuario => {
                                const empresa = database.empresas.find(e => e.ID === usuario.EmpresaID);
                                
                                return `
                                    <tr>
                                        <td><strong>${usuario.Nombre}</strong></td>
                                        <td>${usuario.Email}</td>
                                        <td>
                                            <span style="display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${getRoleColor(usuario.Role)}; font-size: 0.8rem;">
                                                ${getRoleName(usuario.Role)}
                                            </span>
                                        </td>
                                        <td>${empresa ? empresa.Nombre : 'Sin empresa'}</td>
                                        <td>
                                            <span class="status-badge ${usuario.Activo === 'S√≠' ? 'status-active' : 'status-inactive'}">
                                                ${usuario.Activo === 'S√≠' ? 'Activo' : 'Inactivo'}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-btn edit" onclick="editUsuarioCompleto('${usuario.ID}')" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="action-btn delete" onclick="confirmarEliminarUsuario('${usuario.ID}', '${usuario.Nombre}')" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                            ${usuariosParaMostrar.length === 0 ? `
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-user-tie" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No hay usuarios registrados
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    // =============================================
    // M√ìDULO: FUNCIONES AUXILIARES
    // =============================================
    
    function getRoleName(role) {
        const roles = {
            'super': 'Super Admin',
            'jefe': 'Jefe Empresa',
            'comercial': 'Direcci√≥n Comercial',
            'admin': 'Administraci√≥n',
            'vendedor': 'Vendedor',
            'almacen': 'Almac√©n'
        };
        return roles[role] || role;
    }
    
    function getRoleColor(role) {
        switch(role) {
            case 'super': return 'rgba(255,0,85,0.2)';
            case 'jefe': return 'rgba(0,255,65,0.2)';
            case 'comercial': return 'rgba(255,170,0,0.2)';
            case 'admin': return 'rgba(0,170,255,0.2)';
            case 'vendedor': return 'rgba(124,58,237,0.2)';
            case 'almacen': return 'rgba(255,85,0,0.2)';
            default: return 'rgba(255,255,255,0.1)';
        }
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'No disponible';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        } catch (e) {
            return dateString;
        }
    }
    
    // =============================================
    // M√ìDULO: MODALES PARA EMPRESAS
    // =============================================
    
    function showNuevaEmpresaModal() {
        showModal('Nueva Empresa', `
            <div style="max-width: 600px;">
                <div class="form-group">
                    <label style="color: var(--secondary);">Raz√≥n Social *</label>
                    <input type="text" id="nuevaEmpresaNombre" placeholder="Mi Empresa S.A.">
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Pa√≠s *</label>
                    <select id="nuevaEmpresaPais" onchange="actualizarTipoDocumento()" required>
                        <option value="">Seleccionar pa√≠s</option>
                        <option value="Bolivia">Bolivia</option>
                        <option value="Per√∫">Per√∫</option>
                        <option value="Argentina">Argentina</option>
                        <option value="Chile">Chile</option>
                        <option value="Colombia">Colombia</option>
                        <option value="Ecuador">Ecuador</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);" id="labelDocumento">Documento *</label>
                    <input type="text" id="nuevaEmpresaDocumento" placeholder="Ingrese el n√∫mero">
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Industria *</label>
                    <select id="nuevaEmpresaIndustria">
                        <option value="">Seleccionar industria</option>
                        <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                        <option value="Comercio">Comercio</option>
                        <option value="Manufactura">Manufactura</option>
                        <option value="Servicios">Servicios</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Construcci√≥n">Construcci√≥n</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Contacto Principal *</label>
                    <input type="text" id="nuevaEmpresaContacto" placeholder="Juan P√©rez">
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Email *</label>
                    <input type="email" id="nuevaEmpresaEmail" placeholder="contacto@empresa.com">
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Tel√©fono/Celular *</label>
                    <input type="text" id="nuevaEmpresaTelefono" placeholder="+000 00000000">
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Contrase√±a Jefe *</label>
                    <input type="password" id="nuevaEmpresaPassword" value="12345678">
                    <small style="color: rgba(255,255,255,0.6);">Contrase√±a para el usuario jefe</small>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="crearNuevaEmpresa()" style="flex: 1;">
                        <i class="fas fa-plus"></i> Crear Empresa
                    </button>
                </div>
            </div>
        `);
        
        document.getElementById('nuevaEmpresaPais').value = 'Bolivia';
        actualizarTipoDocumento();
    }
    
    function actualizarTipoDocumento() {
        const pais = document.getElementById('nuevaEmpresaPais').value;
        const label = document.getElementById('labelDocumento');
        
        if (pais === 'Bolivia') {
            label.textContent = 'NIT *';
            document.getElementById('nuevaEmpresaDocumento').placeholder = '1234567890123';
        } else if (pais === 'Argentina') {
            label.textContent = 'CUIT *';
            document.getElementById('nuevaEmpresaDocumento').placeholder = '20-12345678-9';
        } else if (pais === 'Chile') {
            label.textContent = 'RUT *';
            document.getElementById('nuevaEmpresaDocumento').placeholder = '12.345.678-9';
        } else if (pais === 'Per√∫') {
            label.textContent = 'RUC *';
            document.getElementById('nuevaEmpresaDocumento').placeholder = '12345678901';
        } else if (pais === 'Colombia') {
            label.textContent = 'NIT *';
            document.getElementById('nuevaEmpresaDocumento').placeholder = '123.456.789-0';
        } else if (pais === 'Ecuador') {
            label.textContent = 'RUC *';
            document.getElementById('nuevaEmpresaDocumento').placeholder = '1234567890001';
        } else {
            label.textContent = 'N√∫mero Fiscal *';
            document.getElementById('nuevaEmpresaDocumento').placeholder = 'Ingrese n√∫mero fiscal';
        }
    }
    
    async function crearNuevaEmpresa() {
        showLoading();
        
        const empresaData = {
            nombre: document.getElementById('nuevaEmpresaNombre').value,
            pais: document.getElementById('nuevaEmpresaPais').value,
            documento: document.getElementById('nuevaEmpresaDocumento').value,
            industria: document.getElementById('nuevaEmpresaIndustria').value,
            contacto: document.getElementById('nuevaEmpresaContacto').value,
            email: document.getElementById('nuevaEmpresaEmail').value,
            telefono: document.getElementById('nuevaEmpresaTelefono').value,
            password: document.getElementById('nuevaEmpresaPassword').value,
            estado: 'Activa'
        };
        
        const required = ['nombre', 'pais', 'documento', 'contacto', 'email', 'telefono', 'password'];
        for (const field of required) {
            if (!empresaData[field]) {
                showNotification('error', 'Error', `Complete el campo: ${field}`);
                hideLoading();
                return;
            }
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(empresaData.email)) {
            showNotification('error', 'Error', 'Ingrese un email v√°lido');
            hideLoading();
            return;
        }
        
        try {
            const result = await postToAPI('registerCompany', empresaData);
            
            if (result && result.success) {
                showNotification('success', '√âxito', `Empresa "${empresaData.nombre}" creada exitosamente`);
                
                await loadEmpresasFromAPI();
                await loadUsuariosFromAPI();
                
                closeModal();
                loadEmpresasManagement();
            } else {
                showNotification('error', 'Error', result?.error || 'Error al crear empresa');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('error', 'Error', 'Error de conexi√≥n: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    function viewEmpresaCompleta(empresaId) {
        const empresa = database.empresas.find(e => e.ID === empresaId);
        if (!empresa) {
            showNotification('error', 'Error', 'Empresa no encontrada');
            return;
        }
        
        const usuariosEmpresa = database.usuarios.filter(u => u.EmpresaID === empresaId);
        const empleadosEmpresa = database.empleados.filter(e => e.EmpresaID === empresaId);
        const productosEmpresa = database.productos.filter(p => p.EmpresaID === empresaId);
        const clientesEmpresa = database.clientes.filter(c => c.EmpresaID === empresaId);
        
        showModal(`Empresa: ${empresa.Nombre}`, `
            <div style="max-width: 800px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: var(--secondary); margin-bottom: 1rem;">Informaci√≥n General</h4>
                        <p><strong>RUC/NIT:</strong> ${empresa.RUC || 'No registrado'}</p>
                        <p><strong>Industria:</strong> ${empresa.Industria || 'No especificada'}</p>
                        <p><strong>Contacto:</strong> ${empresa.Contacto || 'No registrado'}</p>
                        <p><strong>Email:</strong> ${empresa.Email || 'No registrado'}</p>
                        <p><strong>Tel√©fono:</strong> ${empresa.Tel√©fono || 'No registrado'}</p>
                        <p><strong>Estado:</strong> ${empresa.Estado || 'Inactiva'}</p>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--secondary); margin-bottom: 1rem;">Ubicaci√≥n</h4>
                        <p><strong>Direcci√≥n:</strong> ${empresa.Direcci√≥n || 'No registrada'}</p>
                        <p><strong>Ciudad:</strong> ${empresa.Ciudad || 'No registrada'}</p>
                        <p><strong>Tarjeta:</strong> ${empresa.TarjetaRegistrada || 'No'}</p>
                        <p><strong>Fecha Registro:</strong> ${formatDate(empresa.FechaRegistro)}</p>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">Estad√≠sticas</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                        <div style="background: rgba(124,58,237,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="color: var(--secondary); font-size: 0.9rem;">Usuarios</div>
                            <div style="font-size: 2rem; font-weight: 700;">${usuariosEmpresa.length}</div>
                        </div>
                        <div style="background: rgba(0,245,255,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="color: var(--secondary); font-size: 0.9rem;">Empleados</div>
                            <div style="font-size: 2rem; font-weight: 700;">${empleadosEmpresa.length}</div>
                        </div>
                        <div style="background: rgba(0,255,65,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="color: var(--secondary); font-size: 0.9rem;">Productos</div>
                            <div style="font-size: 2rem; font-weight: 700;">${productosEmpresa.length}</div>
                        </div>
                        <div style="background: rgba(255,170,0,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="color: var(--secondary); font-size: 0.9rem;">Clientes</div>
                            <div style="font-size: 2rem; font-weight: 700;">${clientesEmpresa.length}</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="editEmpresaCompleta('${empresaId}')" style="flex: 1;">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-primary" onclick="accessAsJefeEmpresa('${empresaId}')" style="flex: 1;">
                        <i class="fas fa-sign-in-alt"></i> Acceder como Jefe
                    </button>
                </div>
            </div>
        `);
    }
    
    function editEmpresaCompleta(empresaId) {
        const empresa = database.empresas.find(e => e.ID === empresaId);
        if (!empresa) {
            showNotification('error', 'Error', 'Empresa no encontrada');
            return;
        }
        
        showModal(`Editar Empresa: ${empresa.Nombre}`, `
            <div style="max-width: 700px;">
                <input type="hidden" id="editEmpresaId" value="${empresa.ID || ''}">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label style="color: var(--secondary);">Raz√≥n Social *</label>
                        <input type="text" id="editEmpresaNombre" value="${empresa.Nombre || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">RUC/NIT *</label>
                        <input type="text" id="editEmpresaRUC" value="${empresa.RUC || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Industria *</label>
                        <select id="editEmpresaIndustria" required>
                            <option value="">Seleccionar industria</option>
                            <option value="Tecnolog√≠a" ${empresa.Industria === 'Tecnolog√≠a' ? 'selected' : ''}>Tecnolog√≠a</option>
                            <option value="Comercio" ${empresa.Industria === 'Comercio' ? 'selected' : ''}>Comercio</option>
                            <option value="Manufactura" ${empresa.Industria === 'Manufactura' ? 'selected' : ''}>Manufactura</option>
                            <option value="Servicios" ${empresa.Industria === 'Servicios' ? 'selected' : ''}>Servicios</option>
                            <option value="Alimentos" ${empresa.Industria === 'Alimentos' ? 'selected' : ''}>Alimentos</option>
                            <option value="Construcci√≥n" ${empresa.Industria === 'Construcci√≥n' ? 'selected' : ''}>Construcci√≥n</option>
                            <option value="Otros" ${empresa.Industria === 'Otros' ? 'selected' : ''}>Otros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Contacto *</label>
                        <input type="text" id="editEmpresaContacto" value="${empresa.Contacto || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Email *</label>
                        <input type="email" id="editEmpresaEmail" value="${empresa.Email || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Tel√©fono *</label>
                        <input type="text" id="editEmpresaTelefono" value="${empresa.Tel√©fono || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Direcci√≥n</label>
                        <input type="text" id="editEmpresaDireccion" value="${empresa.Direcci√≥n || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Ciudad</label>
                        <input type="text" id="editEmpresaCiudad" value="${empresa.Ciudad || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Estado *</label>
                        <select id="editEmpresaEstado" required>
                            <option value="Activa" ${empresa.Estado === 'Activa' ? 'selected' : ''}>Activa</option>
                            <option value="Inactiva" ${empresa.Estado === 'Inactiva' ? 'selected' : ''}>Inactiva</option>
                            <option value="Pendiente" ${empresa.Estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Tarjeta Registrada</label>
                        <select id="editEmpresaTarjeta">
                            <option value="S√≠" ${empresa.TarjetaRegistrada === 'S√≠' ? 'selected' : ''}>S√≠</option>
                            <option value="No" ${empresa.TarjetaRegistrada === 'No' ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                </div>
                
                <div style="background: rgba(124,58,237,0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <p style="color: var(--secondary); margin: 0;">
                        <i class="fas fa-info-circle"></i> ID de la empresa: <strong>${empresa.ID || 'N/A'}</strong>
                    </p>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="guardarEdicionEmpresaCompleta('${empresaId}')" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        `);
    }

    async function guardarEdicionEmpresaCompleta(empresaId) {
        showLoading();
        
        const empresaData = {
            id: empresaId,
            nombre: document.getElementById('editEmpresaNombre').value,
            documento: document.getElementById('editEmpresaRUC').value,
            industria: document.getElementById('editEmpresaIndustria').value,
            contacto: document.getElementById('editEmpresaContacto').value,
            email: document.getElementById('editEmpresaEmail').value,
            telefono: document.getElementById('editEmpresaTelefono').value,
            direccion: document.getElementById('editEmpresaDireccion').value,
            ciudad: document.getElementById('editEmpresaCiudad').value,
            estado: document.getElementById('editEmpresaEstado').value,
            tarjetaregistrada: document.getElementById('editEmpresaTarjeta').value
        };
        
        const required = ['nombre', 'documento', 'industria', 'contacto', 'email', 'telefono', 'estado'];
        for (const field of required) {
            if (!empresaData[field]) {
                showNotification('error', 'Error', `Complete el campo: ${field}`);
                hideLoading();
                return;
            }
        }
        
        try {
            const result = await postToAPI('updateEmpresaCompleta', empresaData);
            
            if (result && result.success) {
                showNotification('success', '√âxito', 'Empresa actualizada completamente');
                
                await loadEmpresasFromAPI();
                
                closeModal();
                loadEmpresasManagement();
            } else {
                showNotification('error', 'Error', result?.error || 'Error al actualizar');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('error', 'Error', 'Error de conexi√≥n: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    function confirmarEliminarEmpresa(empresaId, empresaNombre) {
        showConfirmation(
            'Eliminar Empresa',
            `¬øEst√°s seguro de eliminar la empresa "${empresaNombre}"?<br><br><small style="color: var(--danger);">Esta acci√≥n eliminar√° TODOS los usuarios de esta empresa y NO se puede deshacer.</small>`,
            function() {
                eliminarEmpresa(empresaId);
            }
        );
    }

    async function eliminarEmpresa(empresaId) {
        showLoading();
        
        try {
            const result = await postToAPI('deleteEmpresa', { id: empresaId });
            
            if (result && result.success) {
                showNotification('success', '√âxito', 'Empresa eliminada correctamente');
                
                await loadEmpresasFromAPI();
                await loadUsuariosFromAPI();
                
                loadEmpresasManagement();
            } else {
                showNotification('error', 'Error', result?.error || 'Error al eliminar');
            }
        } catch (error) {
            showNotification('error', 'Error', 'Error de conexi√≥n: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    function manageUsuariosEmpresa(empresaId) {
        const empresa = database.empresas.find(e => e.ID === empresaId);
        const usuariosEmpresa = database.usuarios.filter(u => u.EmpresaID === empresaId);
        
        showModal(`Usuarios de: ${empresa.Nombre}`, `
            <div style="max-width: 800px;">
                <div style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="showNuevoUsuarioParaEmpresa('${empresaId}')">
                        <i class="fas fa-user-plus"></i> Agregar Usuario
                    </button>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${usuariosEmpresa.map(usuario => `
                                <tr>
                                    <td>${usuario.Nombre}</td>
                                    <td>${usuario.Email}</td>
                                    <td>
                                        <span style="display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${getRoleColor(usuario.Role)}; font-size: 0.8rem;">
                                            ${getRoleName(usuario.Role)}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge ${usuario.Activo === 'S√≠' ? 'status-active' : 'status-inactive'}">
                                            ${usuario.Activo === 'S√≠' ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn edit" onclick="editUsuarioCompleto('${usuario.ID}')" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                            ${usuariosEmpresa.length === 0 ? `
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No hay usuarios en esta empresa
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `);
    }

    // =============================================
    // M√ìDULO: FUNCIONES DE USUARIOS
    // =============================================

    function showNuevoUsuarioModalAvanzado() {
        showModal('Nuevo Usuario', `
            <div style="max-width: 700px;">
                <div class="form-group">
                    <label style="color: var(--secondary);">Empresa *</label>
                    <select id="nuevoUsuarioEmpresaAvanzado" required>
                        <option value="">Seleccionar empresa</option>
                        ${database.empresas.map(empresa => `
                            <option value="${empresa.ID}">${empresa.Nombre}</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Nombres Completos *</label>
                    <input type="text" id="nuevoUsuarioNombres" placeholder="Juan Carlos P√©rez G√≥mez" required>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Email *</label>
                    <input type="email" id="nuevoUsuarioEmailAvanzado" placeholder="usuario@empresa.com" required>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Password *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="nuevoUsuarioPasswordAvanzado" value="12345678" required style="flex: 1;">
                        <button type="button" onclick="generarPasswordNuevoUsuario()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-random"></i> Generar
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label style="color: var(--secondary);">Rol *</label>
                        <select id="nuevoUsuarioRolAvanzado" required>
                            <option value="jefe">Jefe Empresa</option>
                            <option value="comercial">Direcci√≥n Comercial</option>
                            <option value="admin">Administraci√≥n y Finanzas</option>
                            <option value="vendedor">Vendedor App</option>
                            <option value="almacen">Almac√©n App</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Estado *</label>
                        <select id="nuevoUsuarioActivoAvanzado" required>
                            <option value="S√≠">Activo</option>
                            <option value="No">Inactivo</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="crearNuevoUsuarioAvanzado()" style="flex: 1;">
                        <i class="fas fa-user-plus"></i> Crear Usuario
                    </button>
                </div>
            </div>
        `);
    }

    function showNuevoUsuarioParaEmpresa(empresaId) {
        const empresa = database.empresas.find(e => e.ID === empresaId);
        
        showModal(`Nuevo Usuario para: ${empresa.Nombre}`, `
            <div style="max-width: 600px;">
                <input type="hidden" id="nuevoUsuarioEmpresaEspecifica" value="${empresaId}">
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Nombres Completos *</label>
                    <input type="text" id="nuevoUsuarioNombresEspecifico" placeholder="Juan Carlos P√©rez G√≥mez" required>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Email *</label>
                    <input type="email" id="nuevoUsuarioEmailEspecifico" placeholder="usuario@${empresa.Email?.split('@')[1] || 'empresa.com'}" required>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Password *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="nuevoUsuarioPasswordEspecifico" value="12345678" required style="flex: 1;">
                        <button type="button" onclick="generarPasswordNuevoUsuarioEspecifico()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-random"></i> Generar
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label style="color: var(--secondary);">Rol *</label>
                        <select id="nuevoUsuarioRolEspecifico" required>
                            <option value="jefe">Jefe Empresa</option>
                            <option value="comercial">Direcci√≥n Comercial</option>
                            <option value="admin">Administraci√≥n y Finanzas</option>
                            <option value="vendedor">Vendedor App</option>
                            <option value="almacen">Almac√©n App</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Estado *</label>
                        <select id="nuevoUsuarioActivoEspecifico" required>
                            <option value="S√≠">Activo</option>
                            <option value="No">Inactivo</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="crearNuevoUsuarioParaEmpresaEspecifica('${empresaId}')" style="flex: 1;">
                        <i class="fas fa-user-plus"></i> Crear Usuario
                    </button>
                </div>
            </div>
        `);
    }

    function generarPasswordNuevoUsuario() {
        const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$';
        let password = '';
        for (let i = 0; i < 10; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('nuevoUsuarioPasswordAvanzado').value = password;
    }

    function generarPasswordNuevoUsuarioEspecifico() {
        const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$';
        let password = '';
        for (let i = 0; i < 10; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('nuevoUsuarioPasswordEspecifico').value = password;
    }

    async function crearNuevoUsuarioAvanzado() {
        showLoading();
        
        const nombresCompletos = document.getElementById('nuevoUsuarioNombres').value.trim();
        const email = document.getElementById('nuevoUsuarioEmailAvanzado').value.trim().toLowerCase();
        const password = document.getElementById('nuevoUsuarioPasswordAvanzado').value.trim();
        const role = document.getElementById('nuevoUsuarioRolAvanzado').value;
        const activo = document.getElementById('nuevoUsuarioActivoAvanzado').value;
        const empresaId = document.getElementById('nuevoUsuarioEmpresaAvanzado').value;
        
        const usuarioData = {
            nombre: nombresCompletos,
            email: email,
            password: password,
            role: role,
            activo: activo,
            empresa_id: empresaId
        };
        
        if (!nombresCompletos || !email || !empresaId) {
            showNotification('error', 'Error', 'Complete los campos obligatorios marcados con *');
            hideLoading();
            return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNotification('error', 'Error', 'Ingrese un email v√°lido');
            hideLoading();
            return;
        }
        
        try {
            const result = await postToAPI('addUsuario', usuarioData);
            
            if (result && result.success) {
                showNotification('success', '√âxito', `Usuario "${nombresCompletos}" creado exitosamente`);
                
                await loadUsuariosFromAPI();
                
                closeModal();
                loadGestionPersonal();
            } else {
                showNotification('error', 'Error', result?.error || 'Error al crear usuario');
            }
        } catch (error) {
            showNotification('error', 'Error', 'Error de conexi√≥n: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    async function crearNuevoUsuarioParaEmpresaEspecifica(empresaId) {
        showLoading();
        
        const nombresCompletos = document.getElementById('nuevoUsuarioNombresEspecifico').value.trim();
        const email = document.getElementById('nuevoUsuarioEmailEspecifico').value.trim().toLowerCase();
        const password = document.getElementById('nuevoUsuarioPasswordEspecifico').value.trim();
        const role = document.getElementById('nuevoUsuarioRolEspecifico').value;
        const activo = document.getElementById('nuevoUsuarioActivoEspecifico').value;
        
        const usuarioData = {
            nombre: nombresCompletos,
            email: email,
            password: password,
            role: role,
            activo: activo,
            empresa_id: empresaId
        };
        
        if (!nombresCompletos || !email) {
            showNotification('error', 'Error', 'Complete los campos obligatorios');
            hideLoading();
            return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNotification('error', 'Error', 'Ingrese un email v√°lido');
            hideLoading();
            return;
        }
        
        try {
            const result = await postToAPI('addUsuario', usuarioData);
            
            if (result && result.success) {
                showNotification('success', '√âxito', `Usuario "${nombresCompletos}" creado exitosamente`);
                
                await loadUsuariosFromAPI();
                
                closeModal();
                manageUsuariosEmpresa(empresaId);
            } else {
                showNotification('error', 'Error', result?.error || 'Error al crear usuario');
            }
        } catch (error) {
            showNotification('error', 'Error', 'Error de conexi√≥n: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    function editUsuarioCompleto(usuarioId) {
        const usuario = database.usuarios.find(u => u.ID === usuarioId);
        if (!usuario) {
            showNotification('error', 'Error', 'Usuario no encontrado');
            return;
        }
        
        showModal(`Editar Usuario: ${usuario.Nombre}`, `
            <div style="max-width: 700px;">
                <input type="hidden" id="editUsuarioId" value="${usuario.ID || ''}">
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Nombres Completos *</label>
                    <input type="text" id="editUsuarioNombres" value="${usuario.Nombre || ''}" required>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Email *</label>
                    <input type="email" id="editUsuarioEmail" value="${usuario.Email || ''}" required>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--secondary);">Password *</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" id="editUsuarioPassword" value="${usuario.Password || '12345678'}" required style="flex: 1;">
                        <button type="button" onclick="generarPasswordUsuario()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-random"></i> Generar
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label style="color: var(--secondary);">Rol *</label>
                        <select id="editUsuarioRol" required>
                            <option value="jefe" ${usuario.Role === 'jefe' ? 'selected' : ''}>Jefe Empresa</option>
                            <option value="comercial" ${usuario.Role === 'comercial' ? 'selected' : ''}>Direcci√≥n Comercial</option>
                            <option value="admin" ${usuario.Role === 'admin' ? 'selected' : ''}>Administraci√≥n y Finanzas</option>
                            <option value="vendedor" ${usuario.Role === 'vendedor' ? 'selected' : ''}>Vendedor App</option>
                            <option value="almacen" ${usuario.Role === 'almacen' ? 'selected' : ''}>Almac√©n App</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Empresa *</label>
                        <select id="editUsuarioEmpresa" required>
                            <option value="">Seleccionar empresa</option>
                            ${database.empresas.map(emp => `
                                <option value="${emp.ID}" ${usuario.EmpresaID === emp.ID ? 'selected' : ''}>${emp.Nombre}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--secondary);">Estado *</label>
                        <select id="editUsuarioActivo" required>
                            <option value="S√≠" ${usuario.Activo === 'S√≠' ? 'selected' : ''}>Activo</option>
                            <option value="No" ${usuario.Activo === 'No' ? 'selected' : ''}>Inactivo</option>
                        </select>
                    </div>
                </div>
                
                <div style="background: rgba(124,58,237,0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <p style="color: var(--secondary); margin: 0;">
                        <i class="fas fa-info-circle"></i> ID del usuario: <strong>${usuario.ID || 'N/A'}</strong>
                    </p>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="guardarUsuarioCompleto('${usuarioId}')" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        `);
    }

    function generarPasswordUsuario() {
        const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%';
        let password = '';
        for (let i = 0; i < 10; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('editUsuarioPassword').value = password;
    }

    async function guardarUsuarioCompleto(usuarioId) {
        showLoading();
        
        const nombresCompletos = document.getElementById('editUsuarioNombres').value.trim();
        const email = document.getElementById('editUsuarioEmail').value.trim().toLowerCase();
        const password = document.getElementById('editUsuarioPassword').value.trim();
        const role = document.getElementById('editUsuarioRol').value;
        const activo = document.getElementById('editUsuarioActivo').value;
        const empresaId = document.getElementById('editUsuarioEmpresa').value;
        
        const usuarioData = {
            id: usuarioId,
            nombre: nombresCompletos,
            email: email,
            password: password,
            role: role,
            activo: activo,
            empresa_id: empresaId
        };
        
        if (!nombresCompletos || !email || !empresaId) {
            showNotification('error', 'Error', 'Complete los campos obligatorios marcados con *');
            hideLoading();
            return;
        }
        
        try {
            const result = await postToAPI('updateUsuario', usuarioData);
            
            if (result && result.success) {
                showNotification('success', '√âxito', 'Usuario guardado correctamente');
                
                await loadUsuariosFromAPI();
                
                closeModal();
                loadGestionPersonal();
            } else {
                showNotification('error', 'Error', result?.error || 'Error al guardar usuario');
            }
        } catch (error) {
            showNotification('error', 'Error', 'Error de conexi√≥n: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    function confirmarEliminarUsuario(usuarioId, usuarioNombre) {
        showConfirmation(
            'Eliminar Usuario',
            `¬øEst√°s seguro de eliminar al usuario "${usuarioNombre}"?<br><br><small style="color: var(--danger);">Esta acci√≥n NO se puede deshacer.</small>`,
            function() {
                eliminarUsuario(usuarioId);
            }
        );
    }

    async function eliminarUsuario(usuarioId) {
        showLoading();
        
        try {
            const result = await postToAPI('deleteUsuario', { id: usuarioId });
            
            if (result && result.success) {
                showNotification('success', '√âxito', 'Usuario eliminado correctamente');
                
                await loadUsuariosFromAPI();
                
                loadGestionPersonal();
            } else {
                showNotification('error', 'Error', result?.error || 'Error al eliminar');
            }
        } catch (error) {
            showNotification('error', 'Error', 'Error de conexi√≥n: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    // =============================================
    // M√ìDULO: FUNCIONES DE ACCESO
    // =============================================
    
    function accessAsJefeEmpresa(empresaId) {
        const empresa = database.empresas.find(e => e.ID === empresaId);
        if (!empresa) {
            showNotification('error', 'Error', 'Empresa no encontrada');
            return;
        }
        
        showConfirmation(
            'Acceder como Jefe',
            `¬øAcceder a la empresa "${empresa.Nombre}" como jefe?<br><br><small>Podr√°s ver y gestionar esta empresa como si fueras su jefe.</small>`,
            function() {
                currentUser.role = 'jefe';
                currentUser.empresa = empresa.Nombre;
                currentUser.empresa_id = empresaId;
                currentCompany = empresa;
                
                configureInterface();
                
                showNotification('success', 'Modo Jefe', `Ahora eres jefe de ${empresa.Nombre}`);
            }
        );
    }
    
    // =============================================
    // M√ìDULO: FUNCIONES DE MODALES
    // =============================================
    
    function showModal(title, content) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modalOverlay').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('modalOverlay').style.display = 'none';
    }
    
    function showConfirmation(title, message, onConfirm) {
        document.getElementById('confirmationTitle').textContent = title;
        document.getElementById('confirmationMessage').innerHTML = message;
        document.getElementById('confirmationDialog').style.display = 'flex';
        
        const confirmBtn = document.getElementById('confirmActionBtn');
        confirmBtn.onclick = function() {
            hideConfirmation();
            onConfirm();
        };
    }
    
    function hideConfirmation() {
        document.getElementById('confirmationDialog').style.display = 'none';
    }
    
    // =============================================
    // M√ìDULO: NOTIFICACIONES
    // =============================================
    
    function showNotification(type, title, message) {
        const notification = {
            id: Date.now(),
            type: type,
            title: title,
            message: message,
            time: 'Ahora',
            read: false
        };
        
        notifications.unshift(notification);
        
        const unread = notifications.filter(n => !n.read).length;
        document.querySelector('.notification-badge').textContent = unread;
        
        // Solo mostrar toast para errores importantes
        if (type === 'error' || type === 'success') {
            showToast(type, title, message);
        }
    }
    
    function showToast(type, title, message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? 'rgba(0,255,65,0.1)' : type === 'error' ? 'rgba(255,0,85,0.1)' : 'rgba(124,58,237,0.1)'};
            border: 1px solid ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--primary)'};
            color: white;
            padding: 1rem;
            border-radius: 8px;
            min-width: 300px;
            max-width: 400px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `;
        
        toast.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <strong style="color: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--primary)'}">
                    ${title}
                </strong>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">${message}</div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }
    
    function toggleNotifications() {
        showModal('Notificaciones', `
            <div style="max-height: 400px; overflow-y: auto;">
                ${notifications.map(notif => `
                    <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); background: ${notif.read ? 'transparent' : 'rgba(124,58,237,0.05)'};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong style="color: ${notif.type === 'warning' ? 'var(--warning)' : notif.type === 'error' ? 'var(--danger)' : 'var(--secondary)'}">
                                ${notif.title}
                            </strong>
                            <small style="color: rgba(255,255,255,0.5);">${notif.time}</small>
                        </div>
                        <p style="color: rgba(255,255,255,0.7); margin: 0;">${notif.message}</p>
                    </div>
                `).join('')}
                
                ${notifications.length === 0 ? `
                    <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.5);">
                        <i class="fas fa-bell-slash" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No hay notificaciones</p>
                    </div>
                ` : ''}
            </div>
            
            ${notifications.length > 0 ? `
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="markAllAsRead()">
                        <i class="fas fa-check-double"></i> Marcar todas como le√≠das
                    </button>
                    <button class="btn btn-primary" onclick="closeModal()">
                        Cerrar
                    </button>
                </div>
            ` : ''}
        `);
    }
    
    function markAllAsRead() {
        notifications.forEach(n => n.read = true);
        document.querySelector('.notification-badge').textContent = '0';
        closeModal();
    }
    
    // =============================================
    // M√ìDULO: SESI√ìN Y LOGOUT
    // =============================================
    
    function showLogoutConfirmation() {
        showConfirmation(
            'Cerrar Sesi√≥n',
            '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
            logout
        );
    }
    
    function logout() {
        localStorage.removeItem('nexial_user');
        window.location.href = 'index.html';
    }
    
    // =============================================
    // M√ìDULO: INICIALIZACI√ìN
    // =============================================
    
    async function startSession() {
        console.log('üîÑ Iniciando sesi√≥n...');
        
        const savedUser = localStorage.getItem('nexial_user');
        
        if (!savedUser) {
            console.log('‚ùå No hay sesi√≥n guardada');
            window.location.href = 'index.html';
            return;
        }
        
        try {
            currentUser = JSON.parse(savedUser);
            console.log('üë§ Usuario cargado:', currentUser);
            
            configureInterface();
            
            showLoading();
            await loadAllData();
            hideLoading();
            
            showNotification('success', 'Sistema cargado', 'Conectado a Google Sheets. Datos cargados correctamente.');
            
        } catch (error) {
            console.error('Error iniciando sesi√≥n:', error);
            showNotification('error', 'Error de sesi√≥n', 'Por favor, vuelve a iniciar sesi√≥n');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 3000);
        }
    }
    
    // =============================================
    // EVENT LISTENERS
    // =============================================
    
    document.addEventListener('DOMContentLoaded', function() {
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        document.getElementById('confirmationDialog').addEventListener('click', function(e) {
            if (e.target === this) {
                hideConfirmation();
            }
        });
        
        startSession();
        
        console.log('üöÄ Nexial Suite Panel de Control inicializado');
        console.log('üìä Sistema Corporativo Multiempresa v3.1 - PRODUCCI√ìN');
        console.log('üîó API URL:', API_URL);
        console.log('üìÅ Conectado a Google Sheets:', '15lTP0GBO0RKeIKBvAmC-8UFijJKOcawYzjhO5CCndRo');
    });

</script>
