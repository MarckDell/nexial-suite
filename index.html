<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexial Suite - Sistema Empresarial Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="pwa-manifest.json">
    <style>
        /* (MANTENER TODOS LOS ESTILOS CSS EXISTENTES SIN CAMBIOS) */
        /* TODOS LOS ESTILOS CYBERPUNK SE MANTIENEN IGUAL */
        /* ... c√≥digo CSS completo sin cambios ... */
    </style>
    
    <!-- INCLUIR SUPABASE JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- BLOQUE: PART√çCULAS DE FONDO -->
    <div class="particles" id="particles"></div>
    
    <!-- BLOQUE: LOADING GLOBAL -->
    <div class="loading" id="globalLoading">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: var(--secondary);">Procesando...</p>
    </div>
    
    <!-- BLOQUE: HEADER PRINCIPAL -->
    <header class="cyber-header">
        <div class="cyber-logo">
            <i class="fas fa-brain"></i>
            NEXIAL SUITE
        </div>
        <nav class="cyber-nav">
            <a href="#inicio">Inicio</a>
            <a href="#caracteristicas">Sistema</a>
            <a href="#ventajas">Ventajas</a>
            <a href="#" onclick="openRegisterModal()">Registro</a>
        </nav>
        <button class="cyber-btn" onclick="openLoginModal()">
            <i class="fas fa-sign-in-alt"></i> Acceso
        </button>
    </header>

    <!-- BLOQUE: SECCI√ìN HERO -->
    <section class="cyber-hero" id="inicio">
        <h1>Transforma tu Gesti√≥n Empresarial</h1>
        <p class="cyber-subtitle">
            Sistema integral multiempresa. Control total, m√°xima eficiencia.
            Apps para ventas, distribuci√≥n y almacenes en tiempo real.
        </p>
        <button class="cyber-btn" style="padding: 1.2rem 2.5rem; font-size: 1.1rem;" onclick="openRegisterModal()">
            <i class="fas fa-rocket"></i> COMENZAR PRUEBA GRATUITA
        </button>
    </section>

    <!-- BLOQUE: CARACTER√çSTICAS DEL SISTEMA -->
    <section class="cyber-features" id="caracteristicas">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h2 style="color: var(--secondary); font-size: 2.5rem; animation: fadeInUp 1s ease-out;">SISTEMA POR √ÅREAS ESPECIALIZADAS</h2>
            <p style="opacity: 0.8;">Cada √°rea con funciones espec√≠ficas y control total</p>
        </div>
        
        <div class="features-grid">
            <!-- (MANTENER TODAS LAS TARJETAS DE CARACTER√çSTICAS IGUAL) -->
            <!-- ... contenido de caracter√≠sticas sin cambios ... -->
        </div>
    </section>

    <!-- BLOQUE: SECCI√ìN DE VENTAJAS -->
    <section class="cyber-features" id="ventajas" style="background: var(--dark);">
        <!-- (MANTENER SECCI√ìN DE VENTAJAS IGUAL) -->
        <!-- ... contenido de ventajas sin cambios ... -->
    </section>

    <!-- BLOQUE: FOOTER -->
    <footer class="cyber-footer">
        <!-- (MANTENER FOOTER IGUAL) -->
        <!-- ... contenido del footer sin cambios ... -->
    </footer>

    <!-- ============================================= -->
    <!-- MODALES DEL SISTEMA (CON CORRECCIONES) -->
    <!-- ============================================= -->

    <!-- MODAL: LOGIN -->
    <div class="cyber-modal" id="loginModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeLoginModal()">√ó</button>
            
            <div class="modal-header">
                <h2><i class="fas fa-sign-in-alt"></i> ACCESO AL SISTEMA</h2>
                <p style="color: rgba(255,255,255,0.7);">Ingresa con tus credenciales</p>
            </div>
            
            <div class="alert" id="loginAlert"></div>
            
            <div class="form-group">
                <label><i class="fas fa-envelope"></i> Email</label>
                <input type="email" id="loginEmail" placeholder="tu@email.com" autofocus>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-key"></i> Contrase√±a</label>
                <div class="password-wrapper">
                    <input type="password" id="loginPassword" placeholder="Tu contrase√±a">
                    <button type="button" class="toggle-password" onclick="togglePassword('loginPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <div style="text-align: right; margin: 1rem 0;">
                <a href="#" onclick="recoverPassword()" style="color: var(--primary); text-decoration: none;">
                    <i class="fas fa-unlock-alt"></i> ¬øOlvidaste tu contrase√±a?
                </a>
            </div>
            
            <button class="cyber-btn" style="width: 100%; padding: 1rem; font-size: 1.1rem;" onclick="loginWithSupabase()">
                <i class="fas fa-sign-in-alt"></i> INGRESAR AL SISTEMA
            </button>
            
            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <p style="color: rgba(255,255,255,0.7);">¬øNo tienes cuenta?</p>
                <button class="cyber-btn btn-secondary" onclick="closeLoginModal(); openRegisterModal();" style="width: 100%; margin-top: 0.5rem;">
                    <i class="fas fa-building"></i> REGISTRAR EMPRESA
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: REGISTRO DE DIRECTOR EJECUTIVO (PASO 1) -->
    <div class="cyber-modal" id="registerDirectorModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeRegisterDirectorModal()">√ó</button>
            
            <div class="modal-header">
                <h2><i class="fas fa-user-tie"></i> REGISTRO DE DIRECTOR EJECUTIVO</h2>
                <p style="color: rgba(255,255,255,0.7);">Paso 1: Complete sus datos personales</p>
            </div>
            
            <!-- Indicador de pasos -->
            <div class="step-indicator">
                <div class="step active">
                    <div class="step-circle">1</div>
                    <div class="step-label">Director Ejecutivo</div>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-circle">2</div>
                    <div class="step-label">Empresa</div>
                </div>
            </div>
            
            <div class="info-banner">
                <h3><i class="fas fa-info-circle"></i> IMPORTANTE</h3>
                <p>Usted ser√° registrado como el <strong>Director Ejecutivo</strong> de la empresa. Ser√° el primer usuario y tendr√° acceso total al sistema.</p>
            </div>
            
            <div class="alert" id="registerDirectorAlert"></div>
            
            <form id="registerDirectorForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Nombres Completos *</label>
                    <input type="text" id="directorNames" required placeholder="Ej: Juan Carlos">
                </div>
                
                <div class="name-grid">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Primer Apellido *</label>
                        <input type="text" id="directorFirstLastName" required placeholder="Apellido paterno">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Segundo Apellido</label>
                        <input type="text" id="directorSecondLastName" placeholder="Apellido materno">
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> DNI / Documento de Identidad *</label>
                    <input type="text" id="directorDNI" required placeholder="Ej: 12345678" maxlength="20">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email Personal *</label>
                    <input type="email" id="directorEmail" required placeholder="juan.carlos@gmail.com">
                    <small style="color: rgba(255,255,255,0.6); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                        Este ser√° su email de acceso al sistema
                    </small>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-phone"></i> Tel√©fono/Celular *</label>
                    <div class="phone-container">
                        <div class="form-group country-code">
                            <select id="directorCountryCode" required>
                                <option value="+591">+591 (BO)</option>
                                <option value="+51">+51 (PE)</option>
                                <option value="+56">+56 (CL)</option>
                                <option value="+54">+54 (AR)</option>
                                <option value="+55">+55 (BR)</option>
                                <option value="+57">+57 (CO)</option>
                                <option value="+58">+58 (VE)</option>
                                <option value="+52">+52 (MX)</option>
                                <option value="+1">+1 (US/CA)</option>
                                <option value="+34">+34 (ES)</option>
                            </select>
                        </div>
                        <div class="form-group phone-number">
                            <input type="tel" id="directorPhone" required placeholder="60000000">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-key"></i> Contrase√±a *</label>
                    <div class="password-wrapper">
                        <input type="password" id="directorPassword" required minlength="8" placeholder="M√≠nimo 8 caracteres">
                        <button type="button" class="toggle-password" onclick="togglePassword('directorPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-key"></i> Confirmar Contrase√±a *</label>
                    <div class="password-wrapper">
                        <input type="password" id="directorConfirmPassword" required minlength="8" placeholder="Repita su contrase√±a">
                        <button type="button" class="toggle-password" onclick="togglePassword('directorConfirmPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cyber-btn btn-secondary" onclick="closeRegisterDirectorModal()">
                        Cancelar
                    </button>
                    <button type="button" class="cyber-btn" onclick="registerDirector()">
                        <i class="fas fa-arrow-right"></i> SIGUIENTE: REGISTRAR EMPRESA
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: REGISTRO DE EMPRESA (PASO 2) -->
    <div class="cyber-modal" id="registerCompanyModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeRegisterCompanyModal()">√ó</button>
            
            <div class="modal-header">
                <h2><i class="fas fa-building"></i> REGISTRO DE EMPRESA</h2>
                <p style="color: rgba(255,255,255,0.7);">Paso 2: Complete los datos de su empresa</p>
            </div>
            
            <!-- Indicador de pasos -->
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-circle"><i class="fas fa-check"></i></div>
                    <div class="step-label">Director Ejecutivo</div>
                </div>
                <div class="step-line"></div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">Empresa</div>
                </div>
            </div>
            
            <div class="info-banner">
                <h3><i class="fas fa-gift"></i> 30 D√çAS DE PRUEBA GRATUITA</h3>
                <p>Reg√≠strese hoy y obtenga acceso completo por 30 d√≠as sin costo</p>
            </div>
            
            <div class="alert" id="registerCompanyAlert"></div>
            
            <form id="registerCompanyForm">
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Raz√≥n Social *</label>
                    <input type="text" id="companyName" required placeholder="Ej: Mi Empresa S.A.">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> NIT / RUC / Documento Tributario *</label>
                    <input type="text" id="companyRUC" required placeholder="Ej: 1234567890" maxlength="20">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-industry"></i> Tipo de Industria *</label>
                    <select id="companyIndustry" required>
                        <option value="">Seleccionar industria</option>
                        <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                        <option value="Comercio">Comercio</option>
                        <option value="Manufactura">Manufactura</option>
                        <option value="Servicios">Servicios</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Construcci√≥n">Construcci√≥n</option>
                        <option value="Mineria">Miner√≠a</option>
                        <option value="Agricultura">Agricultura</option>
                        <option value="Turismo">Turismo</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Persona de Contacto *</label>
                    <input type="text" id="companyContact" required placeholder="Nombre del contacto principal">
                    <small style="color: rgba(255,255,255,0.6); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                        Generalmente el director ejecutivo
                    </small>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email Corporativo</label>
                    <input type="email" id="companyEmail" placeholder="contacto@empresa.com">
                    <small style="color: rgba(255,255,255,0.6); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                        Email oficial de la empresa (opcional)
                    </small>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-phone"></i> Tel√©fono de la Empresa *</label>
                    <div class="phone-container">
                        <div class="form-group country-code">
                            <select id="companyCountryCode" required>
                                <option value="+591">+591 (BO)</option>
                                <option value="+51">+51 (PE)</option>
                                <option value="+56">+56 (CL)</option>
                                <option value="+54">+54 (AR)</option>
                                <option value="+55">+55 (BR)</option>
                                <option value="+57">+57 (CO)</option>
                                <option value="+58">+58 (VE)</option>
                                <option value="+52">+52 (MX)</option>
                                <option value="+1">+1 (US/CA)</option>
                                <option value="+34">+34 (ES)</option>
                            </select>
                        </div>
                        <div class="form-group phone-number">
                            <input type="tel" id="companyPhone" required placeholder="60000000">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> Direcci√≥n *</label>
                    <input type="text" id="companyAddress" required placeholder="Direcci√≥n completa">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-city"></i> Ciudad *</label>
                    <input type="text" id="companyCity" required placeholder="Ciudad donde opera">
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="termsCheckbox" required>
                    <label for="termsCheckbox">
                        Acepto los <a href="#" onclick="showTerms()">t√©rminos y condiciones</a> del servicio y autorizo el tratamiento de mis datos seg√∫n la normativa aplicable.
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cyber-btn btn-secondary" onclick="goBackToDirector()">
                        <i class="fas fa-arrow-left"></i> ATR√ÅS
                    </button>
                    <button type="button" class="cyber-btn" onclick="registerCompanyComplete()">
                        <i class="fas fa-check-circle"></i> REGISTRAR EMPRESA
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN SUPABASE
        // =============================================
        const SUPABASE_URL = 'https://irunkzdiloimwbchgczm.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_Qi7oFmXllT6wnk2lVZxILA_n90qjrBW';
        
        // Inicializar cliente Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Datos temporales del Director Ejecutivo
        let directorData = null;
        
        // =============================================
        // M√ìDULO: UTILIDADES VISUALES
        // =============================================
        
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.width = Math.random() * 4 + 1 + 'px';
                particle.style.height = particle.style.width;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = Math.random() * 20 + 10 + 's';
                particle.style.animationDelay = Math.random() * 5 + 's';
                particlesContainer.appendChild(particle);
            }
        }
        
        function showLoading() {
            document.getElementById('globalLoading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('globalLoading').style.display = 'none';
        }
        
        function showAlert(elementId, type, message) {
            const alertElement = document.getElementById(elementId);
            alertElement.className = `alert alert-${type}`;
            alertElement.innerHTML = message;
            alertElement.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }
        }
        
        // =============================================
        // M√ìDULO: MANEJO DE MODALES
        // =============================================
        
        function openLoginModal() {
            closeAllModals();
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loginEmail').focus();
            document.body.style.overflow = 'hidden';
        }
        
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginAlert').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.body.style.overflow = 'auto';
        }
        
        function openRegisterModal() {
            closeAllModals();
            directorData = null;
            document.getElementById('registerDirectorModal').style.display = 'flex';
            document.getElementById('directorNames').focus();
            document.body.style.overflow = 'hidden';
        }
        
        function closeRegisterDirectorModal() {
            if (confirm('¬øEst√° seguro de cancelar el registro? Se perder√°n todos los datos ingresados.')) {
                document.getElementById('registerDirectorModal').style.display = 'none';
                document.getElementById('registerDirectorAlert').style.display = 'none';
                document.getElementById('registerDirectorForm').reset();
                directorData = null;
                document.body.style.overflow = 'auto';
            }
        }
        
        function openRegisterCompanyModal() {
            document.getElementById('registerDirectorModal').style.display = 'none';
            document.getElementById('registerCompanyModal').style.display = 'flex';
            document.getElementById('companyName').focus();
        }
        
        function closeRegisterCompanyModal() {
            if (confirm('¬øEst√° seguro de cancelar el registro de empresa?')) {
                document.getElementById('registerCompanyModal').style.display = 'none';
                document.getElementById('registerCompanyAlert').style.display = 'none';
                document.getElementById('registerCompanyForm').reset();
                directorData = null;
                document.body.style.overflow = 'auto';
            }
        }
        
        function goBackToDirector() {
            document.getElementById('registerCompanyModal').style.display = 'none';
            document.getElementById('registerDirectorModal').style.display = 'flex';
        }
        
        function closeAllModals() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('registerDirectorModal').style.display = 'none';
            document.getElementById('registerCompanyModal').style.display = 'none';
        }
        
        // =============================================
        // M√ìDULO: FUNCIONES DEL FORMULARIO
        // =============================================
        
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.parentElement.querySelector('.toggle-password');
            const icon = button.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        function showTerms() {
            alert('T√âRMINOS Y CONDICIONES NEXIAL SUITE\n\n1. Uso exclusivo para empresas registradas\n2. Los datos ser√°n tratados conforme a las leyes de protecci√≥n de datos\n3. Per√≠odo de prueba gratuito de 30 d√≠as\n4. Cancelaci√≥n en cualquier momento\n5. Responsabilidad del usuario sobre la veracidad de los datos\n6. Nexial Suite se reserva el derecho de suspender cuentas con informaci√≥n falsa');
            return false;
        }
        
        // =============================================
        // M√ìDULO: REGISTRO DE DIRECTOR EJECUTIVO (PASO 1)
        // =============================================
        
        async function registerDirector() {
            showLoading();
            
            // Validar contrase√±as
            const password = document.getElementById('directorPassword').value;
            const confirmPassword = document.getElementById('directorConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showAlert('registerDirectorAlert', 'error', 'Las contrase√±as no coinciden');
                hideLoading();
                return;
            }
            
            if (password.length < 8) {
                showAlert('registerDirectorAlert', 'error', 'La contrase√±a debe tener m√≠nimo 8 caracteres');
                hideLoading();
                return;
            }
            
            // Recopilar datos
            const countryCode = document.getElementById('directorCountryCode').value;
            const phoneNumber = document.getElementById('directorPhone').value;
            
            directorData = {
                names: document.getElementById('directorNames').value.trim(),
                firstLastName: document.getElementById('directorFirstLastName').value.trim(),
                secondLastName: document.getElementById('directorSecondLastName').value.trim() || '',
                dni: document.getElementById('directorDNI').value.trim(),
                email: document.getElementById('directorEmail').value.trim().toLowerCase(),
                phone: countryCode + ' ' + phoneNumber,
                password: password
            };
            
            // Validar campos requeridos
            const requiredFields = ['names', 'firstLastName', 'dni', 'email'];
            
            for (const field of requiredFields) {
                if (!directorData[field] || directorData[field].toString().trim() === '') {
                    const fieldNames = {
                        'names': 'Nombres Completos',
                        'firstLastName': 'Primer Apellido',
                        'dni': 'DNI / Documento de Identidad',
                        'email': 'Email Personal'
                    };
                    showAlert('registerDirectorAlert', 'error', `Por favor complete el campo: ${fieldNames[field] || field}`);
                    hideLoading();
                    return;
                }
            }
            
            // Validar DNI
            if (!directorData.dni || directorData.dni.trim() === '' || directorData.dni.length < 3) {
                showAlert('registerDirectorAlert', 'error', 'Por favor ingrese un DNI v√°lido');
                hideLoading();
                return;
            }
            
            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(directorData.email)) {
                showAlert('registerDirectorAlert', 'error', 'Por favor ingrese un email v√°lido');
                hideLoading();
                return;
            }
            
            // Verificar si el email ya existe en Supabase Auth
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: directorData.email,
                    password: 'dummyPassword123' // Contrase√±a dummy solo para verificar
                });
                
                // Si no hay error de credenciales inv√°lidas, el usuario existe
                if (error && error.message !== 'Invalid login credentials') {
                    showAlert('registerDirectorAlert', 'error', 'Este email ya est√° registrado');
                    hideLoading();
                    return;
                }
            } catch (error) {
                // Continuar con el registro
            }
            
            hideLoading();
            
            // Almacenar datos en localStorage temporal
            localStorage.setItem('temp_director_data', JSON.stringify(directorData));
            
            // Continuar al paso 2
            openRegisterCompanyModal();
        }
        
        // =============================================
        // M√ìDULO: REGISTRO COMPLETO DE EMPRESA (PASO 2)
        // =============================================
        
        async function registerCompanyComplete() {
            showLoading();
            
            // Recuperar datos del director
            if (!directorData) {
                const storedData = localStorage.getItem('temp_director_data');
                if (storedData) {
                    directorData = JSON.parse(storedData);
                } else {
                    showAlert('registerCompanyAlert', 'error', 'Error: No se encontraron datos del director ejecutivo');
                    hideLoading();
                    return;
                }
            }
            
            // Recopilar datos de la empresa
            const countryCode = document.getElementById('companyCountryCode').value;
            const phoneNumber = document.getElementById('companyPhone').value;
            
            const companyData = {
                nombre: document.getElementById('companyName').value.trim(),
                ruc: document.getElementById('companyRUC').value.trim(),
                industria: document.getElementById('companyIndustry').value,
                persona_contacto: document.getElementById('companyContact').value.trim(),
                email_corporativo: document.getElementById('companyEmail').value.trim().toLowerCase() || null,
                telefono: countryCode + ' ' + phoneNumber,
                direccion: document.getElementById('companyAddress').value.trim(),
                ciudad: document.getElementById('companyCity').value.trim()
            };
            
            // Validar campos requeridos de empresa
            const requiredCompanyFields = ['nombre', 'ruc', 'industria', 'persona_contacto'];
            
            for (const field of requiredCompanyFields) {
                if (!companyData[field] || companyData[field].toString().trim() === '') {
                    const fieldNames = {
                        'nombre': 'Raz√≥n Social',
                        'ruc': 'NIT / RUC',
                        'industria': 'Tipo de Industria',
                        'persona_contacto': 'Persona de Contacto'
                    };
                    showAlert('registerCompanyAlert', 'error', `Por favor complete el campo: ${fieldNames[field] || field}`);
                    hideLoading();
                    return;
                }
            }
            
            // Validar RUC
            if (!companyData.ruc || companyData.ruc.trim() === '' || companyData.ruc.length < 3) {
                showAlert('registerCompanyAlert', 'error', 'Por favor ingrese un NIT/RUC v√°lido');
                hideLoading();
                return;
            }
            
            // Verificar t√©rminos aceptados
            if (!document.getElementById('termsCheckbox').checked) {
                showAlert('registerCompanyAlert', 'error', 'Debe aceptar los t√©rminos y condiciones');
                hideLoading();
                return;
            }
            
            try {
                // 1. REGISTRAR USUARIO EN SUPABASE AUTH
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: directorData.email,
                    password: directorData.password,
                    options: {
                        data: {
                            nombres: directorData.names,
                            apellido_paterno: directorData.firstLastName,
                            apellido_materno: directorData.secondLastName,
                            dni: directorData.dni,
                            telefono: directorData.phone,
                            rol: 'director'
                        }
                    }
                });
                
                if (authError) {
                    throw new Error(`Error en registro de usuario: ${authError.message}`);
                }
                
                if (!authData.user) {
                    throw new Error('No se pudo crear el usuario en Auth');
                }
                
                // 2. CREAR EMPRESA EN TABLA EMPRESAS
                const { data: empresaData, error: empresaError } = await supabase
                    .from('empresas')
                    .insert([companyData])
                    .select()
                    .single();
                
                if (empresaError) {
                    // Intentar eliminar el usuario de Auth si falla la creaci√≥n de empresa
                    await supabase.auth.admin.deleteUser(authData.user.id);
                    throw new Error(`Error al crear empresa: ${empresaError.message}`);
                }
                
                // 3. CREAR REGISTRO EN TABLA USUARIOS
                const { error: usuarioError } = await supabase
                    .from('usuarios')
                    .insert([{
                        id: authData.user.id,
                        empresa_id: empresaData.id,
                        email: directorData.email,
                        nombre: directorData.names,
                        apellido_paterno: directorData.firstLastName,
                        apellido_materno: directorData.secondLastName,
                        dni: directorData.dni,
                        telefono: directorData.phone,
                        rol: 'director',
                        permisos: {
                            dashboard: true,
                            ventas: true,
                            inventario: true,
                            reportes: true,
                            configuracion: true,
                            usuarios: true,
                            finanzas: true
                        }
                    }]);
                
                if (usuarioError) {
                    // Eliminar empresa si falla la creaci√≥n de usuario
                    await supabase.from('empresas').delete().eq('id', empresaData.id);
                    await supabase.auth.admin.deleteUser(authData.user.id);
                    throw new Error(`Error al crear usuario: ${usuarioError.message}`);
                }
                
                // 4. CREAR REGISTRO EN TABLA EMPLEADOS
                const { error: empleadoError } = await supabase
                    .from('empleados')
                    .insert([{
                        empresa_id: empresaData.id,
                        usuario_id: authData.user.id,
                        cargo: 'Director Ejecutivo',
                        departamento: 'Direcci√≥n',
                        tipo_contrato: 'Indefinido'
                    }]);
                
                if (empleadoError) {
                    console.warn('Advertencia: No se pudo crear registro de empleado, pero el usuario y empresa fueron creados');
                }
                
                // 5. MOSTRAR √âXITO
                hideLoading();
                
                const successMessage = `
                    <div style="text-align: center;">
                        <h3 style="color: var(--success); margin-bottom: 1rem;">‚úÖ ¬°REGISTRO EXITOSO!</h3>
                        <div style="background: rgba(0,255,65,0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p><strong>üè¢ Empresa:</strong> ${companyData.nombre}</p>
                            <p><strong>üìã RUC:</strong> ${companyData.ruc}</p>
                            <p><strong>üë§ Director:</strong> ${directorData.names} ${directorData.firstLastName}</p>
                            <p><strong>üìß Email:</strong> ${directorData.email}</p>
                            <p><strong>üîë Contrase√±a:</strong> ${'*'.repeat(directorData.password.length)}</p>
                            <p><strong>üëî Rol:</strong> Director Ejecutivo</p>
                            <p><strong>üÜî ID Empresa:</strong> ${empresaData.id}</p>
                        </div>
                        <p style="color: var(--secondary); margin-top: 1rem;">
                            <i class="fas fa-envelope"></i> Se ha enviado un email de confirmaci√≥n a ${directorData.email}
                        </p>
                        <p style="font-size: 0.9rem; opacity: 0.8;">
                            Puede iniciar sesi√≥n ahora con sus credenciales
                        </p>
                    </div>
                `;
                
                showAlert('registerCompanyAlert', 'success', successMessage);
                
                // Limpiar datos temporales
                localStorage.removeItem('temp_director_data');
                directorData = null;
                
                // Cerrar modales despu√©s de 8 segundos
                setTimeout(() => {
                    document.getElementById('registerDirectorForm').reset();
                    document.getElementById('registerCompanyForm').reset();
                    closeRegisterCompanyModal();
                    
                    // Rellenar el email en el login
                    document.getElementById('loginEmail').value = directorData?.email || '';
                    openLoginModal();
                }, 8000);
                
            } catch (error) {
                console.error('‚ùå Error en registro completo:', error);
                hideLoading();
                
                const errorMessage = `
                    <div style="text-align: center;">
                        <h3 style="color: var(--danger); margin-bottom: 1rem;">‚ùå ERROR EN REGISTRO</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 1rem; font-size: 0.9rem;">
                            Por favor contacte a soporte: marcelodanielcc@gmail.com
                        </p>
                    </div>
                `;
                
                showAlert('registerCompanyAlert', 'error', errorMessage);
                
                // Limpiar datos temporales
                localStorage.removeItem('temp_director_data');
                directorData = null;
            }
        }
        
        // =============================================
        // M√ìDULO: LOGIN CON SUPABASE
        // =============================================
        
        async function loginWithSupabase() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('loginAlert', 'error', 'Por favor complete todos los campos');
                return;
            }
            
            showLoading();
            
            try {
                // 1. INICIAR SESI√ìN EN SUPABASE AUTH
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                if (!data.user) {
                    throw new Error('No se pudo autenticar el usuario');
                }
                
                // 2. OBTENER DATOS DEL USUARIO DE LA TABLA USUARIOS
                const { data: usuarioData, error: usuarioError } = await supabase
                    .from('usuarios')
                    .select(`
                        *,
                        empresas (*)
                    `)
                    .eq('id', data.user.id)
                    .single();
                
                if (usuarioError) {
                    console.warn('Usuario autenticado pero no encontrado en tabla usuarios');
                }
                
                // 3. ACTUALIZAR √öLTIMO LOGIN
                await supabase
                    .from('usuarios')
                    .update({ ultimo_login: new Date().toISOString() })
                    .eq('id', data.user.id);
                
                // 4. GUARDAR DATOS EN LOCALSTORAGE
                const userSession = {
                    id: data.user.id,
                    email: data.user.email,
                    nombre: usuarioData?.nombre || data.user.user_metadata?.nombres || 'Usuario',
                    apellido: usuarioData?.apellido_paterno || data.user.user_metadata?.apellido_paterno || '',
                    rol: usuarioData?.rol || 'director',
                    empresa_id: usuarioData?.empresa_id,
                    empresa_nombre: usuarioData?.empresas?.nombre || 'Sin empresa',
                    permisos: usuarioData?.permisos || {}
                };
                
                localStorage.setItem('nexial_user', JSON.stringify(userSession));
                localStorage.setItem('supabase_session', JSON.stringify(data.session));
                
                // 5. MOSTRAR √âXITO Y REDIRIGIR
                hideLoading();
                
                showAlert('loginAlert', 'success', 
                    '‚úÖ ¬°Login exitoso! Redirigiendo al dashboard...');
                
                setTimeout(() => {
                    closeLoginModal();
                    window.location.href = 'dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error en login:', error);
                hideLoading();
                
                // Verificar si es el super admin (fallback)
                if (email === 'marcelodanielcc@gmail.com' && password === '789') {
                    const superAdminSession = {
                        id: 'SUPER-ADMIN-001',
                        email: 'marcelodanielcc@gmail.com',
                        nombre: 'Administrador Corporativo',
                        apellido: 'Marcelo Daniel Coarite Condori',
                        rol: 'super',
                        empresa_id: null,
                        empresa_nombre: 'Nexial Suite',
                        permisos: { all: true }
                    };
                    
                    localStorage.setItem('nexial_user', JSON.stringify(superAdminSession));
                    
                    showAlert('loginAlert', 'success', 
                        '‚úÖ ¬°Login Super Admin exitoso! Redirigiendo...');
                    
                    setTimeout(() => {
                        closeLoginModal();
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showAlert('loginAlert', 'error', 
                        `Error de autenticaci√≥n: ${error.message}`);
                }
            }
        }
        
        // =============================================
        // M√ìDULO: FUNCIONES AUXILIARES
        // =============================================
        
        function recoverPassword() {
            const email = prompt('Ingrese su email para recuperar contrase√±a:');
            if (email) {
                supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/reset-password.html`
                }).then(({ error }) => {
                    if (error) {
                        alert(`Error: ${error.message}`);
                    } else {
                        alert(`Se ha enviado un enlace de recuperaci√≥n a: ${email}\n\nRevise su bandeja de entrada.`);
                    }
                });
            }
        }
        
        function setupDocumentValidation() {
            const dniInput = document.getElementById('directorDNI');
            const rucInput = document.getElementById('companyRUC');
            
            if (dniInput) {
                dniInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
            
            if (rucInput) {
                rucInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
        }
        
        function setupPhoneValidation() {
            const directorPhone = document.getElementById('directorPhone');
            const companyPhone = document.getElementById('companyPhone');
            
            if (directorPhone) {
                directorPhone.addEventListener('input', function(e) {
                    this.value = this.value.replace(/\D/g, '');
                });
            }
            
            if (companyPhone) {
                companyPhone.addEventListener('input', function(e) {
                    this.value = this.value.replace(/\D/g, '');
                });
            }
        }
        
        // =============================================
        // EVENT LISTENERS
        // =============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Enter para login
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loginWithSupabase();
            });
            
            // Enter en director email va al siguiente campo
            document.getElementById('directorEmail')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('directorCountryCode').focus();
                }
            });
            
            // Validaciones de entrada
            setupDocumentValidation();
            setupPhoneValidation();
            
            // Inicializar part√≠culas
            createParticles();
            
            // Verificar sesi√≥n existente
            checkExistingSession();
            
            console.log('üöÄ Nexial Suite - Sistema Empresarial');
            console.log('üìä Versi√≥n: 5.0 (SUPABASE INTEGRADO)');
            console.log('üîó Supabase URL:', SUPABASE_URL);
        });
        
        async function checkExistingSession() {
            const { data, error } = await supabase.auth.getSession();
            if (data.session) {
                console.log('üë§ Sesi√≥n activa encontrada');
                // El usuario ya est√° autenticado, podr√≠a redirigir directamente
            }
        }
    </script>
</body>
</html>
